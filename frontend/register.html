<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация</title>
    <link href="style.css?v=2" rel="stylesheet" type="text/css" />
    <meta name="api-base" content="http://localhost:5000">
</head>

<body>
    <div class="container" style="max-width:520px;">
        <header class="header" style="padding:30px 24px;text-align:left;">
            <h2 class="title" style="margin:0;">Регистрация</h2>
            <p style="margin:8px 0 0 0;color:#666;">Создайте новый аккаунт</p>
        </header>
        <main class="main-content" style="padding:24px;">
            <form id="register-form" class="feedback-section" test-id="register-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="you@example.com" required
                        test-id="email-input">
                    <div class="field-error" id="email-error" style="display:none;"></div>
                </div>

                <div class="form-group">
                    <label for="full_name">Полное имя (необязательно)</label>
                    <input type="text" id="full_name" name="full_name" placeholder="Иван Иванов"
                        test-id="full-name-input">
                </div>

                <div class="form-group">
                    <label for="password">Пароль</label>
                    <input type="password" id="password" name="password" placeholder="••••••••" required
                        test-id="password-input">
                    <div class="field-error" id="password-error" style="display:none;"></div>
                    <small style="color:#666;font-size:12px;">Минимум 8 символов</small>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Подтверждение пароля</label>
                    <input type="password" id="confirm_password" name="confirm_password" placeholder="••••••••" required
                        test-id="confirm-password-input">
                    <div class="field-error" id="confirm-password-error" style="display:none;"></div>
                </div>

                <button type="submit" id="register-btn" test-id="register-submit-btn">Зарегистрироваться</button>
                <p id="register-status" test-id="register-status"></p>
            </form>

            <div style="text-align:center;margin-top:24px;padding-top:24px;border-top:1px solid #eee;">
                <p style="margin:0;color:#666;">Уже есть аккаунт?</p>
                <a href="/login.html" style="color:#667eea;text-decoration:none;font-weight:500;">Войти</a>
            </div>
        </main>
    </div>

    <script>
        // Система регистрации с валидацией
        class RegistrationManager {
            constructor() {
                this.apiBase = (document.querySelector('meta[name="api-base"]')?.content || 'http://localhost:5000').replace(/\/?$/, '');
                this.init();
            }

            init() {
                this.setupFormValidation();
                this.setupFormSubmission();
            }

            setupFormValidation() {
                const passwordInput = document.getElementById('password');
                const confirmPasswordInput = document.getElementById('confirm_password');
                const emailInput = document.getElementById('email');

                // Валидация пароля в реальном времени
                passwordInput.addEventListener('input', () => {
                    this.validatePassword();
                });

                // Валидация подтверждения пароля
                confirmPasswordInput.addEventListener('input', () => {
                    this.validatePasswordConfirmation();
                });

                // Валидация email
                emailInput.addEventListener('input', () => {
                    this.validateEmail();
                });
            }

            setupFormSubmission() {
                const form = document.getElementById('register-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleRegistration();
                });
            }

            validateEmail() {
                const emailInput = document.getElementById('email');
                const errorDiv = document.getElementById('email-error');
                const email = emailInput.value.trim();

                if (!email) {
                    this.hideFieldError(errorDiv);
                    return true;
                }

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    this.showFieldError(errorDiv, 'Введите корректный email');
                    return false;
                }

                this.hideFieldError(errorDiv);
                return true;
            }

            validatePassword() {
                const passwordInput = document.getElementById('password');
                const errorDiv = document.getElementById('password-error');
                const password = passwordInput.value;

                if (!password) {
                    this.hideFieldError(errorDiv);
                    return true;
                }

                if (password.length < 8) {
                    this.showFieldError(errorDiv, 'Пароль должен содержать минимум 8 символов');
                    return false;
                }

                this.hideFieldError(errorDiv);
                return true;
            }

            validatePasswordConfirmation() {
                const passwordInput = document.getElementById('password');
                const confirmPasswordInput = document.getElementById('confirm_password');
                const errorDiv = document.getElementById('confirm-password-error');
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                if (!confirmPassword) {
                    this.hideFieldError(errorDiv);
                    return true;
                }

                if (password !== confirmPassword) {
                    this.showFieldError(errorDiv, 'Пароли не совпадают');
                    return false;
                }

                this.hideFieldError(errorDiv);
                return true;
            }

            showFieldError(errorDiv, message) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                errorDiv.style.color = '#dc3545';
                errorDiv.style.fontSize = '0.875rem';
                errorDiv.style.marginTop = '0.25rem';
            }

            hideFieldError(errorDiv) {
                errorDiv.style.display = 'none';
            }

            validateForm() {
                const isEmailValid = this.validateEmail();
                const isPasswordValid = this.validatePassword();
                const isConfirmPasswordValid = this.validatePasswordConfirmation();

                return isEmailValid && isPasswordValid && isConfirmPasswordValid;
            }

            async handleRegistration() {
                const statusDiv = document.getElementById('register-status');
                const registerBtn = document.getElementById('register-btn');

                // Проверяем валидацию
                if (!this.validateForm()) {
                    statusDiv.textContent = 'Исправьте ошибки в форме';
                    statusDiv.style.color = '#dc3545';
                    return;
                }

                // Получаем данные формы
                const formData = new FormData(document.getElementById('register-form'));
                const registrationData = {
                    email: formData.get('email').trim(),
                    password: formData.get('password'),
                    confirm_password: formData.get('confirm_password'),
                    full_name: formData.get('full_name')?.trim() || null
                };

                // Показываем загрузку
                registerBtn.disabled = true;
                registerBtn.textContent = 'Регистрация...';
                statusDiv.textContent = 'Регистрация...';
                statusDiv.style.color = '#333';

                try {
                    const response = await fetch(`${this.apiBase}/api/auth/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(registrationData)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        statusDiv.textContent = 'Регистрация успешна! Переходим к входу...';
                        statusDiv.style.color = 'green';

                        setTimeout(() => {
                            window.location.href = '/login.html?registered=true';
                        }, 2000);
                    } else {
                        let errorMessage = 'Ошибка регистрации';

                        if (data.detail) {
                            errorMessage = data.detail;
                        } else if (data.errors) {
                            // Обработка ошибок валидации
                            const firstError = Object.values(data.errors)[0];
                            errorMessage = Array.isArray(firstError) ? firstError[0] : firstError;
                        }

                        statusDiv.textContent = errorMessage;
                        statusDiv.style.color = '#dc3545';
                    }
                } catch (error) {
                    console.error('Ошибка регистрации:', error);
                    statusDiv.textContent = 'Сетевая ошибка. Проверьте подключение.';
                    statusDiv.style.color = '#dc3545';
                } finally {
                    registerBtn.disabled = false;
                    registerBtn.textContent = 'Зарегистрироваться';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new RegistrationManager();

            // Показываем сообщение об успешной регистрации, если есть параметр
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('registered') === 'true') {
                const statusDiv = document.getElementById('register-status');
                statusDiv.textContent = 'Регистрация прошла успешно! Теперь войдите в систему.';
                statusDiv.style.color = 'green';
            }
        });
    </script>
</body>

</html>